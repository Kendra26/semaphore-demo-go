version: v1.0
name: Semaphore Go CI example
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
blocks:
  - name: Build project
    task:
      jobs:
        - name: go get & build
          commands:
            - checkout
            - sem-version go 1.19
            - go get
            - go build -o ./bin/main
            - cache store $(checksum main.go) bin
  - name: Check code style
    task:
      jobs:
        - name: gofmt
          commands:
            - checkout
            - sem-version go 1.19
            - gofmt main.go | diff --ignore-tab-expansion main.go -
  - name: Run tests
    task:
      prologue:
        commands:
          - checkout
          - sem-version go 1.19
      jobs:
        - name: go test
          commands:
            - sem-service start postgres
            - psql -p 5432 -h localhost -U postgres -c "CREATE DATABASE s2"
            - go install gotest.tools/gotestsum@latest
            - go get github.com/anacrolix/torrent
            - gotestsum --junitfile junit.xml ./...
        - name: Test web server
          commands:
            - cache restore $(checksum main.go)
            - ./bin/main 8001 &
            - >-
              torrent download
              'magnet:?xt=urn:btih:9FC3BCB83ABC1A5E28C9A84C5A1109990E89A7F3&dn=Silo.S02E02.WEB.x264-PHOENiX&tr=udp%3A%2F%2Fopen.stealth.si%3A80%2Fannounce&tr=udp%3A%2F%2Ftracker.tiny-vps.com%3A6969%2Fannounce&tr=udp%3A%2F%2Ftracker.opentrackr.org%3A1337%2Fannounce&tr=udp%3A%2F%2Ftracker.torrent.eu.org%3A451%2Fannounce&tr=udp%3A%2F%2Fexplodie.org%3A6969%2Fannounce&tr=udp%3A%2F%2Ftracker.cyberia.is%3A6969%2Fannounce&tr=udp%3A%2F%2Fipv4.tracker.harry.lu%3A80%2Fannounce&tr=udp%3A%2F%2Fp4p.arenabg.com%3A1337%2Fannounce&tr=udp%3A%2F%2Ftracker.birkenwald.de%3A6969%2Fannounce&tr=udp%3A%2F%2Ftracker.moeking.me%3A6969%2Fannounce&tr=udp%3A%2F%2Fopentor.org%3A2710%2Fannounce&tr=udp%3A%2F%2Ftracker.dler.org%3A6969%2Fannounce&tr=udp%3A%2F%2Fuploads.gamecoast.net%3A6969%2Fannounce&tr=https%3A%2F%2Ftracker.foreverpirates.co%3A443%2Fannounce&tr=udp%3A%2F%2Ftracker.opentrackr.org%3A1337%2Fannounce&tr=http%3A%2F%2Ftracker.openbittorrent.com%3A80%2Fannounce&tr=udp%3A%2F%2Fopentracker.i2p.rocks%3A6969%2Fannounce&tr=udp%3A%2F%2Ftracker.internetwarriors.net%3A1337%2Fannounce&tr=udp%3A%2F%2Ftracker.leechers-paradise.org%3A6969%2Fannounce&tr=udp%3A%2F%2Fcoppersurfer.tk%3A6969%2Fannounce&tr=udp%3A%2F%2Ftracker.zer0day.to%3A1337%2Fannounce'
      epilogue:
        always:
          commands:
            - test-results publish junit.xml
after_pipeline:
  task:
    jobs:
      - name: Publish Results
        commands:
          - test-results gen-pipeline-report
